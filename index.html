<!--
MTR Train Live Schedule 
https://github.com/sammyfung/mtrtrain
-->
<html lang="en">
<head>
<title>港鐵列車即時班次</title>
<meta name="description" content="港鐵, 時間表, 屯馬綫, 將軍澳綫, 東涌綫, 機場快綫, 東鐵綫, MTR, Tuen Ma Line, TKO Line, Tung Chung Line, Airport Express Line, East Rail Line"/>
<meta charset="utf-8"/>
<style>
th,td { font-size: 32px; text-align: center; }
.std_text { font-size: 32px; }
.head_text { font-size: 48px; }
</style>
</head>
<body>
<h1 id='pagetitle' class='head_text'>港鐵列車即時班次</h1>
<p class='std_text'>綫路： <a href="?line=AEL">機場快綫</a> | <a href="?line=TCL">東涌綫</a> | <a href="?line=TKL">將軍澳綫</a> | <a href="?line=TML">屯馬綫</a> | <a href="?line=EAL">東鐵綫</a> | <a href="/mtrtrain/mtrtrain.html">English</a> .</p>
<p id='curr_time_1' class='curr_time std_text'>現在時間：</p>
<p><h2 class='std_text'>下行列車</h2></p>
<table border='1' id='down' width='100%'>
<!--
<tr><th>車站</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr>
-->
<tr><th>車站</th><th>1</th><th>2</th><th>3</th><th>4</th></tr>
</table>
<p id='curr_time_2' class='curr_time std_text'>現在時間：</p>
<p><h2 class='std_text'>上行列車</h2></p>
<table border='1' id='up' width='100%'>
</table>
<hr/>
<p class='std_text'>綫路： <a href="?line=AEL">機場快綫</a> | <a href="?line=TCL">東涌綫</a> | <a href="?line=TKL">將軍澳綫</a> | <a href="?line=TML">屯馬綫</a> | <a href="?line=EAL">東鐵綫</a> | <a href="/mtrtrain/mtrtrain.html">English</a> .</p>
<p class='std_text'>本程式<a href="https://github.com/sammyfung/mtrtrain">源碼</a>以 Apache 2.0 許可證公開，數據由 <a href='https://data.gov.hk/tc-data/dataset/mtr-data2-nexttrain-data'>資料一線通</a> 提供。</p>
</body>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-4825433-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-4825433-1');
</script>
<!--
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js">
</script>
<script>
$progname = '港鐵列車即時班次';
var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
        }
    }
};
var $line = getUrlParameter('line');
if ($line == undefined || $line == 'TML') {
  $line = 'TML';
  $linename = '屯馬綫';
  $stations = {
        'TUM': '屯門', 'SIH': '兆康', 'TIS': '天水圍',
        'LOP': '朗屏', 'YUL': '元朗', 'KSR': '錦上路',
        'TWW': '荃灣西', 'MEF': '美孚', 'NAC': '南昌',
        'AUS': '柯士甸', 'ETS': '尖東', 'HUH': '紅磡',
        'HOM': '何文田', 'TKW': '土瓜灣', 'SUW': '宋皇臺',
        'KAT': '啟德', 'DIH': '鑽石山', 'HIK': '顯徑',
        'TAW': '大圍', 'CKT': '車公廟', 'STW': '沙田圍',
        'CIO': '第一城', 'SHM': '石門', 'TSH': '大水坑',
        'HEO': '恆安', 'MOS': '馬鞍山', 'WKS': '烏溪沙'
    };
} else if ($line == 'TKL') {
  $line = 'TKL'; 
  $linename = '將軍澳綫';
  $stations = {
	'POA': '寶琳', 'HAH': '坑口', 'LHP': '康城',
	'TKO': '將軍澳', 'TIK': '調景嶺', 'YAT': '油塘',
	'QUB': '鰂魚涌', 'NOP': '北角'
    };
} else if ($line == 'TCL') {
  $line = 'TCL';
  $linename = '東涌綫';
  $stations = {
	'TUC': '東涌', 'SUN': '欣澳', 'TSY': '青衣',
	'LAK': '荔景', 'NAC': '南昌', 'OLY': '奧運',
	'KOW': '九龍','HOK': '香港'
    };
} else if ($line == 'AEL') {
  $line = 'AEL';
  $linename = '機場快綫';
  $stations = {
	'AWE': '博覽館', 'AIR': '機場', 'TSY': '青衣',
        'KOW': '九龍', 'HOK': '香港'
    };
} else if ($line == 'EAL') {
  $line = 'EAL';
  $linename = '東鐵綫';
  $stations = {
'LMC': '落馬洲', 'LOW': '羅湖', 'SHS': '上水',
		'FAN': '粉嶺', 'TWO': '太和', 'TAP': '大埔墟',
		  'UNI': '大學', 'RAC': '馬場', 'FOT': '火炭', 
		  'SHT': '沙田', 'TAW': '大圍', 'KOT': '九龍塘',
		  'MKK': '旺角東', 'HUH': '紅磡', 'EXC': '會展',
		  'ADM': '金鐘'
	  };
};
document.title = $progname + ' - ' + $linename +' (' + $line + ')';
$('#pagetitle').html(document.title);
$url_prefix = 'https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php';
let url = [];
for ($station in Object.keys($stations)) {
  url.push($url_prefix + '?line=' + $line + '&sta=' + Object.keys($stations)[$station]);
}
$.ajaxSetup({
async: false
});
curr_time = undefined;
for ($i in url) {
  //console.log(url[$i]);
  $.getJSON(url[$i], function( data ) {
    //console.log(data);
    var downitems = [];
    var upitems = [];
    if (curr_time == undefined) {
      curr_time = data.curr_time;
      $('.curr_time').html("現在時間：" + curr_time);
    };
    $.each( data.data, function( key, val ) {
       stopcode = key.replace($line + '-', ''); 	    
       downitems.push('<th>' + $stations[stopcode] + ' (' + stopcode + ')</th>');
       $.each( val.DOWN, function( key, val ) {
         if (parseInt(key) < 4) {
           time = val.time;
           time = time.replace(/^[0-9-]* /, '');	       
    	   time = time.replace(/:[0-9]*$/, '');      
	   downitems.push( "<td id='" + key + "'>" + time + " (" + val.dest + ") " + "</td>" );
         };
       });
       upitems.push('<th>' + $stations[stopcode] + ' (' + stopcode + ')</th>');
       $.each( val.UP, function( key, val ) {
         if (parseInt(key) < 4) {
           time = val.time;
           time = time.replace(/^[0-9-]* /, '');
           time = time.replace(/:[0-9]*$/, '');		 
           upitems.push( "<td id='" + key + "'>" + time + " (" + val.dest + ") " + "</td>" );
         }
       });   
    });
    $( "<tr/>", {
      "class": "station-row", 
      html: downitems.join( "" )
    }).appendTo( $("#down") );
    $( "<tr/>", {
      "class": "station-row",
      html: upitems.join( "" )
    }).prependTo( $("#up") );
  })
  .fail(function() {
    console.log( "error" );
  });
}
    $( "<tr/>", {
      "class": "station-row",
      //html: "<th>車站</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th>"
      html: "<th>車站</th><th>1</th><th>2</th><th>3</th><th>4</th>"
    }).prependTo( $("#up") );
//console.log('END');
</script>
</html>
